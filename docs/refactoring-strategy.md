# 広範リファクタリング戦略

## 1. 背景

ユーティリティクラスとそのテストコードのリファクタリングを経て、プロジェクト全体の基準となる方針（基準ドキュメント群）が整備された。これらの基準に基づき、`src` ディレクトリ以下のコード全体に対して、より広範なリファクタリングを実施する。

## 2. 現状分析まとめ

*   **コード構造:** プロジェクトは `core` (基盤), `utils` (汎用), `data` (永続化), `managers` (ドメインロジック), `adapters` (インターフェース), `cli` (コマンドラインツール) という明確なレイヤー構造を持つ。
*   **設計:** クラスベース設計、依存性注入、イベント駆動、カスタムエラークラスなど、基準ドキュメントに沿った設計原則が採用されている（または目指されている）。
*   **テスト状況:** Jest を用いたテストが多数存在するが、広範囲にわたって失敗している。主な原因は、テストヘルパー/環境の問題、依存関係/コンストラクタエラー、アサーション/モックエラー、コード変更への追従漏れ、基準ドキュメントとの乖離などが考えられる。
*   **基準ドキュメント:** プロジェクトの目指すべき方向性を示す詳細なドキュメント群が整備されている。

## 3. リファクタリング戦略

広範囲なテスト失敗はリファクタリングの大きな障害となるため、テストの安定化を最優先とし、以下の段階的な戦略で進める。

**フェーズ 1: テストの安定化 (最優先)**

*   **目的:** テストスイート全体を可能な限りパスさせ、コード変更に対するセーフティネットを確保する。
*   **アクション:**
    1.  **テストヘルパー/環境の問題解決:** `createMockLogger` 未定義エラー、`simple-git` のパスエラー、CLIテストエラー、モジュール解決エラーなどを解消する。
    2.  **依存関係/コンストラクタエラーの解決:** `IntegrationManager is not a constructor` などのエラー、必須依存関係の注入漏れなどを修正する。
    3.  **基本的なアサーション/モックエラーの修正:** 単純な期待値の不一致 (`toBe`, `toContain`) やモック呼び出し検証 (`toHaveBeenCalledWith`) の失敗を修正する。
    4.  **タイムアウトエラーの修正:** `LockManager` テストのタイムアウトを解消する。

**フェーズ 2: コア機能のリファクタリングとテスト修正**

*   **目的:** アプリケーションの基盤となる `core` と `utils` のコードを基準ドキュメントに準拠させ、関連テストを完全にパスさせる。
*   **アクション:**
    *   `ErrorHandler`, `EnhancedEventEmitter`, `Logger`, `StorageService`, `GitService` などをドキュメントと照合し修正。
    *   エラーハンドリングとイベント発行の一貫性を確保。
    *   関連テスト (`error-framework.test.js`, `event-system.test.js` など) を修正しパスさせる。

**フェーズ 3: データ層とマネージャー層のリファクタリングとテスト修正**

*   **目的:** データ永続化とドメインロジックを担当する `data` と `managers` のコードを基準ドキュメントに準拠させ、関連テストをパスさせる。
*   **アクション:**
    *   リポジトリとバリデーターの連携、責務分担を確認・修正。
    *   マネージャークラスのロジックを基準に合わせる（DI、エラー処理、イベント発行）。
    *   関連テスト (`task-repository.test.js`, `task-manager.test.js` など) を修正しパスさせる。

**フェーズ 4: アダプター層と統合テストのリファクタリングとテスト修正**

*   **目的:** アダプター層 (`adapters`) の役割を明確にし、コンポーネント間の連携をテストする統合テストをパスさせる。
*   **アクション:**
    *   アダプタークラスが `BaseAdapter` を適切に利用しているか確認。
    *   マネージャー間の連携ロジック（特に `IntegrationManagerAdapter`）を確認・整理。
    *   関連テスト (`task-manager-adapter.test.js`, `integration-manager-adapter.test.js`, `core-components.test.js` など) を修正しパスさせる。

**フェーズ 5: 全体的なコード改善とドキュメント更新**

*   **目的:** テストが安定した状態で、コード全体の品質向上とドキュメントの最新化を行う。
*   **アクション:**
    *   重複コードの排除、複雑なロジックの単純化。
    *   命名規則の最終確認。
    *   テストカバレッジを確認し、必要に応じてテストケースを追加。
    *   リファクタリング内容に合わせて基準ドキュメント群を更新。

## 4. 戦略の視覚化

```mermaid
graph LR
    subgraph リファクタリング戦略
        A[現状分析] --> B(テスト失敗分析);
        A --> C(コード構造分析);
        A --> D(基準ドキュメント);

        B --> E[フェーズ1: テスト安定化];
        C & D & E --> F[フェーズ2: コア機能リファクタリング];
        F --> G[フェーズ3: データ/マネージャリファクタリング];
        G --> H[フェーズ4: アダプタ/統合リファクタリング];
        H --> I[フェーズ5: 全体改善/ドキュメント更新];
        I --> J(リファクタリング完了);
    end

    subgraph フェーズ1詳細
        E1(テストヘルパー/環境修正);
        E2(依存関係/コンストラクタ修正);
        E3(基本アサーション/モック修正);
        E4(タイムアウト修正);
        E --> E1 & E2 & E3 & E4;
    end

    subgraph フェーズ2-5詳細
        K(基準ドキュメント準拠);
        L(テスト修正/追加);
        M(コード改善);
        F & G & H & I --> K & L & M;
    end