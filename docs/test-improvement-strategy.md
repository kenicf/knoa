# テスト環境改善戦略

## 1. 現状分析と課題

*   **テストカバレッジ:** 全体で約52%と低く、特に `src/cli` (約5.6%)、`src/lib/data` (約1.9%)、`src/lib/managers` (約16.8%) のカバレッジが著しく低い。これは、これらの領域のコード変更に対する安全性が低いことを意味します。
*   **ユーティリティクラス:** `src/lib/utils` はカバレッジが約94%と高いですが、テストの質（網羅性、アサーションの適切さなど）については別途確認が必要です。
*   **リファクタリング計画:** 今後、プロジェクト全体のリファクタリングが予定されており、テストはその品質保証と安全性確保のために不可欠です。
*   **テスト環境:** JestとESLintは導入済みですが、カバレッジ閾値の設定、推奨プラグインの活用、CI連携の強化など、改善の余地があります。

## 2. テスト環境改善の目的

*   **リファクタリングの安全性確保:** コード変更によるデグレード（意図しない機能破壊）を早期に検出するセーフティネットを構築します。
*   **コード品質の維持・向上:** テストを通じてコードの振る舞いを明確にし、潜在的なバグを発見しやすくします。
*   **開発効率の向上:** 自動テストにより、手動での動作確認の手間を削減します。

## 3. テスト環境改善戦略 (段階的アプローチ)

リファクタリング計画と並行して、以下の3つのフェーズで段階的にテスト環境を改善します。

```mermaid
graph TD
    subgraph テスト環境改善戦略
        A[現状分析: 低カバレッジ、リファクタリング予定] --> B(フェーズ1: 基盤整備と低カバレッジ対策);
        B --> C(フェーズ2: リファクタリングと並行したテスト改善);
        C --> D(フェーズ3: 高度化と継続的改善);

        subgraph フェーズ1: 基盤整備と低カバレッジ対策 (リファクタリング前〜初期)
            B1[Jest: カバレッジ閾値設定 (低め)];
            B2[ESLint: 推奨プラグイン有効化/ルール見直し];
            B3[CI: カバレッジレポート保存, 脆弱性スキャン強化];
            B4[テスト追加: 低カバレッジ重要箇所 (data, managers)];
        end

        subgraph フェーズ2: リファクタリングと並行したテスト改善
            C1[リファクタリング対象のテスト先行改善];
            C2[テスト容易性を考慮したリファクタリング];
            C3[リファクタリング後のカバレッジ/品質確認];
            C4[ユーティリティクラスのテスト見直し];
        end

        subgraph フェーズ3: 高度化と継続的改善
            D1[カバレッジ閾値の段階的引き上げ];
            D2[高度な静的解析ツール検討 (SonarCloud等)];
            D3[依存関係ルールチェック検討 (dependency-cruiser等)];
            D4[テスト種類拡充検討 (結合テスト等)];
        end

        B --> B1 & B2 & B3 & B4;
        C --> C1 & C2 & C3 & C4;
        D --> D1 & D2 & D3 & D4;

        B4 --> C1;
        C1 --> C2;
        C2 --> C3;
        C3 --> D1;
    end
```

## 4. 各フェーズの詳細

### フェーズ1: 基盤整備と低カバレッジ対策 (リファクタリング前〜初期)

*   **目的:** リファクタリングを安全に進めるための最低限のテスト基盤を構築し、特にリスクの高い箇所のカバレッジを向上させます。
*   **具体的なアクション:**
    1.  **Jest カバレッジ閾値設定:**
        *   `package.json` または `jest.config.js` に `coverageThreshold` を設定します。まずは達成可能な目標として、`global` で `lines: 60%`, `branches: 55%`, `functions: 60%` 程度を設定し、CIで下回ったら失敗するようにします。
        *   CIワークフロー (`.github/workflows/ci.yml`) で、テスト実行後にカバレッジレポート（例: `coverage/lcov-report/index.html`）をアーティファクトとして保存し、確認しやすくします。
    2.  **ESLint 設定強化:**
        *   `eslint.config.js` でコメントアウトされている `eslint-plugin-node` を有効化し、Node.js固有のルールチェックを追加します。
        *   `eslint-plugin-promise`, `eslint-plugin-security` などのルールを確認し、必要に応じて調整します。
        *   `no-unused-vars` ルールを `'warn'` に戻し、`argsIgnorePattern: '^_', varsIgnorePattern: '^_'` を設定します (CIでの動作を再確認)。
    3.  **CI パイプライン改善:**
        *   `npm audit --audit-level=high` が確実に実行されていることを確認します。
        *   GitHubリポジトリ設定で **Dependabot** を有効化し、依存関係の脆弱性チェックと自動修正PR作成を依頼します (リポジトリ管理者による操作)。
    4.  **低カバレッジ箇所のテスト追加:**
        *   カバレッジレポートを参考に、特に低い `src/lib/data` と `src/lib/managers` の中で、**コアとなる機能**や**リファクタリング予定の箇所**から優先的に基本的な単体テストを追加します。
        *   目標: まずはこれらのディレクトリのカバレッジを少しでも引き上げ、リファクタリングのリスクを低減します (例: 30%〜40%程度を目指す)。

### フェーズ2: リファクタリングと並行したテスト改善

*   **目的:** リファクタリング対象モジュールの品質をテストで担保し、テスト容易性も向上させます。
*   **具体的なアクション:**
    1.  **テスト先行改善:** リファクタリング対象のモジュールについて、着手前に既存のテストコードをレビューし、[テスト戦略とガイドライン](testing-guidelines.md) に基づいて改善します。特に、**エラーケース**や**境界値**のテストが不足している場合は追加します。
    2.  **テスト容易性を考慮したリファクタリング:** リファクタリング中に、テストが書きにくい（依存関係が密結合、副作用が多いなど）箇所があれば、[設計原則とパターン](design-principles.md)（特にDI）に基づいて、テストしやすい構造に改善します。
    3.  **リファクタリング後の確認:** リファクタリング完了後、テストがすべてパスすることを確認し、カバレッジがフェーズ1で設定した閾値や、モジュールごとの目標値（例: 80%）を満たしているかを確認します。
    4.  **ユーティリティクラスのテスト見直し:** カバレッジが高い `src/lib/utils` のテストも、リファクタリングガイドラインやテスト戦略に基づいて見直し、アサーションの質や網羅性を確認・改善します。

### フェーズ3: 高度化と継続的改善

*   **目的:** テスト環境をさらに強化し、高品質な状態を維持する仕組みを定着させます。
*   **具体的なアクション:**
    1.  **カバレッジ閾値の引き上げ:** プロジェクトの進捗に合わせて `coverageThreshold` の目標値を段階的に引き上げます (例: 80% -> 90%)。
    2.  **高度な静的解析:** SonarCloud などのツール導入を検討し、コードの複雑度、重複、潜在的なバグや脆弱性をより詳細に分析します。
    3.  **依存関係ルール:** `dependency-cruiser` などのツールを導入し、「`data` 層は `manager` 層に依存してはいけない」といったアーキテクチャルールを定義・強制することを検討します。
    4.  **テスト種類の拡充:** 必要に応じて、単体テストだけでなく、複数のモジュールを連携させる結合テストや、CLIツールとしての動作を確認するE2Eテストなどの導入を検討します。